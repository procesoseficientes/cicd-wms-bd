-- =============================================
-- Autor:				juancarlos.escalante
-- Fecha de Creacion: 	06-04-2016 @Team ERGON - Sprint HYPER
-- Description:			SP para generar el reporte de ingresos generales

-- Autor:				rudi.garcia
-- Fecha de Creacion: 	06-01-2017 @Team ERGON - Sprint Epona
-- Description:			Se agrego campo IS_EXTERNAL_INVENTORY

-- Autor:				rudi.garcia
-- Fecha de Creacion: 	31-08-2017 @Team ERGON - Sprint Collin
-- Description:			Se agrego la condicion de que solo sea "INICIALIZACION_FISCAL" y "INGRESO_FISCAL"

-- Modificacion 02-Sep-17 @ Nexus Team Sprint CommandAndConquer
-- alberto.ruiz
-- Se agregan campos de la solicitud de traslado y manifiesto de carga

-- Autor:	        hector.gonzalez
-- Fecha de Creacion: 	2017-09-05 @ Team REBORN - Sprint Collin
-- Description:	   Se agregaron columnas de STADO 

-- Autor:	        hector.gonzalez
-- Fecha de Creacion: 	2017-09-16 @ Team REBORN - Sprint Collin
-- Description:	   Se agrega tono y calibre

-- Autor:	        hector.gonzalez
-- Fecha de Creacion: 	2017-09-20 @ Team REBORN - Sprint Collin
-- Description:	   Se modifica tamanio de columna CLIENT_CODE de tabla @CLIENT por bug

/*
	Ejemplo Ejecucion: 
		EXEC [wms].[OP_WMS_SP_REPORT_GENERAL_INCOME] @FECHA_INICIO = '2017-01-01 00:00:00'
                                              ,@FECHA_FINAL = '2017-09-08 23:59:59'
                                              ,@CLIENT_CODE = 'arium|autovanguard|C00001|C00003|C00004|C00005|C00006|C00007|C00008|C00009|C00010|C00011|C00012|C00013|C00014|C00015|C00016|C00017|C00018|C00019|C00021|C00022|C00023|C00024|C00025|C00026|C00027|C00028|C00029|C00030|C00031|C00032|C00033|C00034|C00035|C00036|C00037|C00038|C00039|C00040|C00041|C00042|C00043|C00044|C00045|C00046|C00047|C00048|C00049|C00050|C00051|C00052|C00053|C00054|C00055|C00056|C00057|C00058|C00059|C00060|C00061|C00062|C00063|C00064|C00065|C00066|C00067|C00068|C00069|C00070|C00071|C00072|C00073|C00074|C00075|C00076|C00077|C00078|C00079|C00080|C00081|C00082|C00083|C00084|C00085|C00086|C00087|C00088|C00089|C00090|C00091|C00092|C00093|C00094|C00095|C00096|C00097|C00098|C00099|C00100|C00101|C00102|C00103|C00104|C00105|C00106|C00107|C00108|C00109|C00110|C00111|C00112|C00113|C00114|C00115|C00116|C00117|C00118|C00119|C00120|C00121|C00122|C00123|C00124|C00125|C00126|C00127|C00128|C00129|C00130|C00131|C00132|C00133|C00134|C00135|C00136|C00137|C00138|C00139|C00140|C00141|C00142|C00143|C00144|C00145|C00146|C00147|C00148|C00149|C00150|C00151|C00152|C00153|C00154|C00155|C00156|C00157|C00158|C00159|C00160|C00161|C00162|C00163|C00164|C00165|C00166|C00167|C00168|C00169|C00170|C00171|C00172|C00173|C00174|C00175|C00176|C00177|C00178|C00179|C00180|C00181|C00182|C00183|C00184|C00185|C00186|C00187|C00188|C00189|C00190|C00191|C00192|C00193|C00194|C00195|C00196|C00197|C00198|C00199|C00200|C00201|C00202|C00203|C00204|C00205|C00206|C00207|C00208|C00209|C00210|C00211|C00212|C00213|C00214|C00215|C00216|C00217|C00218|C00219|C00220|C00221|C00222|C00223|C00224|C00225|C00226|C00227|C00228|C00229|C00230|C00231|C00232|C00233|C00234|C00235|C00236|C00237|C00238|C00239|C00240|C00241|C00242|C00243|C00244|C00245|C00246|C00247|C00248|C00249|C00250|C00251|C00252|C00253|C00254|C00255|C00256|C00257|C00258|C00259|C00260|C00261|C00262|C00263|C00264|C00265|C00266|C00267|C00268|C00269|C00270|C00271|C00272|C00273|C00274|C00275|C00276|C00277|C00278|C00279|C00280|C00281|C00282|C00283|C00284|C00286|C00287|C00288|C00289|C00290|C00291|C00292|C00293|C00294|C00295|C00296|C00297|C00298|C00299|C00300|C00301|C00302|C00303|C00304|C00305|C00306|C00307|C00308|C00309|C00310|C00311|C00312|C00313|C00314|C00315|C00316|C00318|C00319|C00320|C00321|C00322|C00323|C00324|C00325|C00326|C00327|C00328|C00329|C00330|C00331|C00332|C00333|C00334|C00335|C00337|C00338|C00339|C00340|C00341|C00342|C00343|C00344|C00345|C00346|C00347|C00348|C00349|C00350|C00351|C00352|C00353|C00354|C00355|C00356|C00357|C00358|C00359|C00360|C00361|C00362|C00363|C00365|C00366|C00367|C00368|C00369|C00370|C00372|C00373|C00374|C00377|C00378|C00379|C00380|C00381|C00382|C00383|C00384|C00385|C00387|C00388|C00389|C00390|C00391|C00392|C00393|C00394|C00395|C00396|C00397|C00398|C00399|C00400|C00401|C00402|C00403|C00404|C00405|C00412|C00413|C00414|C00415|C00416|C00417|C00418|C00419|C00420|C00421|C00422|C00423|C00424|C00425|C00426|C00427|C00428|C00429|C00430|C00431|C00432|C00433|C00434|C00435|C00436|C00437|C00439|C00440|C00441|C00442|C00443|C00444|C00446|C00447|C00448|C00449|C00451|C00452|C00454|C00455|C00456|C00457|C00458|C00459|C00460|C00461|C00462|C00463|C00464|C00465|C00466|C00467|C00468|C00469|C00470|C00471|C00472|C00473|C00475|C00476|C00478|C00479|C00480|C00482|C00484|C00485|C00486|C00487|C00488|C00489|C00490|C00492|C00493|C00494|C00495|C00496|C00497|C00498|C00499|C00500|C00501|C00502|C00503|C00504|C00505|C00506|C00507|C00508|C00509|C00510|C00511|C00512|C00514|C00515|C00516|C00517|C00518|C00519|C00520|C00521|C00525|C00526|C00527|C00528|C00529|C00530|C00532|C00533|C00534|C00535|C00537|C00538|C00539|C00540|C00541|C00542|C00543|C00544|C00545|C00546|C00547|C00548|C00549|C00550|C00551|C00552|C00553|C00554|C00555|C00556|C00557|C00558|C00559|C00560|C00561|C00562|C00563|C00564|C00565|C00566|C00567|C00568|C00569|C00570|C00571|C00572|C00573|C00574|C00575|C00576|C00577|C00578|C00580|C00581|C00582|C00583|C00584|C00585|C00586|C00587|C00588|C00589|C00590|C00591|C00592|C00593|C00594|C00595|C00596|C00597|C00598|C00599|C00600|C00601|C00602|C00603|C00604|C00605|C00606|C00607|C00608|C00609|C00610|C00611|C00612|C00613|C00614|C00615|C00616|C00617|C00618|C00619|C00620|C00621|C00622|C00623|C00624|C00625|C00626|C00627|C00628|C00629|C00630|C00631|C00632|C00633|C00634|C00635|C00636|C00637|C00638|C00639|C00640|C00641|C00642|C00643|C00644|C00645|C00646|C00647|C00648|C00649|C00650|C00651|C00652|C00653|C00654|C00655|C00656|C00657|C00658|C00659|C00660|C00661|C00662|C00663|C00664|C00665|C00666|C00667|C00669|C00670|C00671|C00672|C00673|C00674|C00675|C00676|C00677|C00678|C00679|C00680|C00681|C00682|C00683|C00684|C00685|C00686|C00687|C00691|C00692|C00693|C00694|C00695|C00696|C00697|C00698|C00699|C00700|C00701|C00702|C00703|C00704|C00705|C00706|C00707|C00708|C00709|C00710|C00711|C00712|C00713|C00714|C00715|C00718|C00719|C00720|C00721|C00722|C00724|C00725|C00727|C00728|C00729|C00730|C00731|C00732|C00733|C00735|C00736|C00737|C00738|C00739|C00740|C00741|C00742|C00743|C00744|C00745|C00746|C00747|C00748|C00750|C00751|C00752|C00753|C00754|C00755|C00756|C00757|C00758|C00759|C00760|C00761|C00762|C00763|C00764|C00765|C00766|C00767|C00768|C00769|C00770|C00771|C00772|C00773|C00774|C00775|C00776|C00777|C00778|C00779|C00780|C00781|C00782|C00783|C00784|C00785|C00786|C00787|C00788|C00789|C00790|C00791|C00792|C00793|C00794|C00795|C00796|C00797|C00798|C00799|C00800|C00801|C00802|C00803|C00804|C00805|C00806|C00807|C00808|C00809|C00810|C00811|C00812|C00813|C00814|C00815|C00816|C00817|C00818|C00819|C00820|C00821|C00822|C00823|C00824|C00825|C00826|C00827|C00828|C00829|C00830|C00831|C00832|C00833|C00834|C00835|C00836|C00837|C00838|C00839|C00840|C00841|C00842|C00843|C00844|C00845|C00846|C00847|C00848|C00849|C00850|C00851|C00852|C00853|C00854|C00855|C00856|C00857|C00858|C00859|C00860|C00861|C00862|C00863|C00864|C00865|C00866|C00867|C00868|C00869|C00870|C00871|C00872|C00873|C00874|C00875|C00876|C00877|C00878|C00879|C00880|C00881|C00882|C00883|C00884|C00885|C00886|C00887|C00888|C00889|C00890|C00891|C00892|C00893|C00894|C00895|C00896|C00897|C00898|C00899|C00900|C00901|C00902|C00903|C00904|C00905|C00906|C00907|C00908|C00909|C00910|C00912|C00913|C00914|C00915|C00916|C00917|C00918|C00919|C00920|C00921|C00922|C00923|C00924|C00925|C00926|C00927|C00928|C00929|C00930|C00931|C00932|C00933|C00934|C00935|C00936|C00937|C00938|C00940|C00941|C00942|C00943|C00945|C00946|C00947|C00948|C00949|C00950|C00951|C00952|C00953|C00954|C00956|C00957|C00958|C00959|C00960|C00961|C00962|C00963|C00964|C00965|C00966|C00967|C00968|C00969|C00970|C00971|C00972|C00973|C00974|C00975|C00976|C00977|C00978|C00979|C00980|C00981|C00982|C00983|C00984|C00985|C00986|C00987|C00988|C00989|C00990|C00991|C00992|C00993|C00994|C00995|C00996|C00997|C00998|C00999|C01000|C01001|C01002|C01003|C01004|C01005|C01006|C01007|C01008|C01009|C01010|C01011|C01012|C01013|C01014|C01015|C01016|C01017|C01018|C01019|C01020|C01021|C01022|C01023|C01024|C01025|C01026|C01027|C01028|C01029|C01030|C01031|C01032|C01033|C01034|C01035|C01036|C01037|C01038|C01039|C01040|C01041|C01042|C01043|C01044|C01045|C01046|C01047|C01048|C01049|C01050|C01051|C01052|C01053|C01054|C01055|C01056|C01057|C01058|C01059|C01060|C01061|C01062|C01063|C01064|C01065|C01066|C01067|C01068|C01069|C01070|C01071|C01072|C01073|C01074|C01075|C01076|C01077|C01078|C01079|C01080|C01081|C01082|C01083|C01084|C01085|C01086|C01087|C01088|C01089|C01090|C01091|C01092|C01093|C01094|C01095|C01096|C01097|C01098|C01099|C01100|C01101|C01102|C01103|C01105|C01106|C01107|C01108|C01109|C01110|C01111|C01112|C01113|C01114|C01115|C01116|C01117|C01118|C01119|C01120|C01121|C01122|C01123|C01124|C01125|C01126|C01127|C01128|C01129|C01130|C01131|C01132|C01133|C01134|C01135|C01136|C01137|C01138|C01139|C01140|C01141|C01142|C01143|C01144|C01145|C01146|C01147|C01148|C01149|C01150|C01151|C01152|C01153|C01154|C01155|C01156|C01157|C01158|C01159|C01160|C01161|C01162|C01163|C01164|C01165|C01166|C01167|C01168|C01169|C01170|C01171|C01172|C01173|C01174|C01176|C01177|C01178|C01179|C01180|C01181|C01182|C01183|C01184|C01185|C01186|C01187|C01188|C01189|C01190|C01191|C01192|C01193|C01194|C01195|C01196|C01197|C01198|C01199|C01200|C01204|C01205|C01206|C01207|C01208|C01209|C01210|C01211|C01213|C01214|C01216|C01217|C01218|C01219|C01220|C01221|C01222|C01223|C01224|C01227|C01228|C01229|C01230|C01231|C01232|C01233|C01234|C01235|C01236|C01237|C01238|C01239|C01240|C01241|C01242|C01243|C01244|C01245|C01246|C01248|C01249|C01250|C01251|C01252|C01253|C01254|C01255|C01256|C01257|C01260|C01261|C01262|C01263|C01264|C01265|C01266|C01267|C01268|C01269|C01270|C01271|C01272|C01273|C01274|C01276|C01277|C01278|C01280|C01281|C01282|C01283|C01285|C01286|C01288|C01289|C01290|C01291|C01292|C01293|C01294|C01295|C01296|C01297|C01298|C01299|C01300|C01301|C01302|C01303|C01304|C01305|C01306|C01307|C01308|C01309|C01310|C01311|C01312|C01313|C01314|C01316|C01317|C01318|C01319|C01320|C01321|C01322|C01323|C01324|C01325|C01326|C01327|C01328|C01329|C01330|C01331|C01332|C01333|C01334|C01335|C01336|C01337|C01339|C01340|C01341|C01342|C01343|C01344|C01345|C01346|C01347|C01348|C01349|C01350|C01351|C01352|C01353|C01354|C01355|C01356|C01358|C01359|C01360|C01361|C01362|C01363|C01364|C01365|C01366|C01367|C01368|C01369|C01370|C01371|C01372|C01373|C01375|C01376|C01377|C01378|C01379|C01380|C01381|C01382|C01383|C01384|C01385|C01386|C01387|C01388|C01389|C01390|C01391|C01393|C01394|C01395|C01396|C01397|C01398|C01399|C01400|C01401|C01402|C01403|C01404|C01405|C01406|C01407|C01408|C01411|C01412|C01413|C01414|C01415|C01416|C01417|C01418|C01419|C01420|C01421|C01422|C01423|C01424|C01425|C01426|wms|motorganica|P00030|P00286|viscosa'
                                              ,@LOGIN = 'ADMIN'
 */
-- =============================================
CREATE PROCEDURE [wms].[OP_WMS_SP_REPORT_GENERAL_INCOME] (@FECHA_INICIO DATETIME
, @FECHA_FINAL DATETIME
, @CLIENT_CODE VARCHAR(MAX)
, @LOGIN VARCHAR(25))
AS
BEGIN
  SET NOCOUNT ON;
  --
  DECLARE @WAREHOUSES TABLE (
    [WAREHOUSE_ID] VARCHAR(25)
   ,[NAME] VARCHAR(50)
   ,[COMMENTS] VARCHAR(150)
   ,[ERP_WAREHOUSE] VARCHAR(50)
   ,[ALLOW_PICKING] NUMERIC
   ,[DEFAULT_RECEPTION_LOCATION] VARCHAR(25)
   ,[SHUNT_NAME] VARCHAR(25)
   ,[WAREHOUSE_WEATHER] VARCHAR(50)
   ,[WAREHOUSE_STATUS] INT
   ,[IS_3PL_WAREHUESE] INT
   ,[WAHREHOUSE_ADDRESS] VARCHAR(250)
   ,[GPS_URL] VARCHAR(100)
   ,[WAREHOUSE_BY_USER_ID] INT
   ,PRIMARY KEY ([WAREHOUSE_ID])
  );

  DECLARE @CLIENT TABLE (
    [CLIENT_CODE] NVARCHAR(25)
    UNIQUE ([CLIENT_CODE])
  )
  --
  DECLARE @STATUS VARCHAR(15) = 'PROCESSED'
         ,@WAREHOUSE_REGIMEN VARCHAR(25) = 'GENERAL'
         ,@TIPO VARCHAR(25) = 'INGRESO'
         ,@TRANS_TYPE_INICIALIZACION_GENERAL VARCHAR(25) = 'INICIALIZACION_GENERAL'
         ,@TRANS_TYPE_INGRESO_GENERAL VARCHAR(25) = 'INGRESO_GENERAL'

  -- ------------------------------------------------------------------------------------
  -- OBtiene los clientes
  -- ------------------------------------------------------------------------------------
  INSERT INTO @CLIENT
    SELECT
      [C].[VALUE] [CLIENT_CODE]
    FROM [wms].[OP_WMS_FUNC_SPLIT](@CLIENT_CODE, '|') [C];

  -- ------------------------------------------------------------------------------------
  -- Obtiene las bodegas asociadas por usuario
  -- ------------------------------------------------------------------------------------
  INSERT INTO @WAREHOUSES
  EXEC [wms].[OP_WMS_SP_GET_WAREHOUSE_ASSOCIATED_WITH_USER] @LOGIN_ID = @LOGIN;

  -- ------------------------------------------------------------------------------------
  -- Muestra el resultado
  -- ------------------------------------------------------------------------------------
  SELECT
    [PH].[DOC_ID]
   ,[PH].[NUMERO_ORDEN] AS [ORDEN]
   ,[PH].[CODIGO_POLIZA] AS [POLIZA]
   ,[T].[CLIENT_OWNER] [CLIENT_CODE]--[PH].[CLIENT_CODE]
   ,[T].[CLIENT_NAME] AS [CLIENTE]
   ,[PH].[FECHA_DOCUMENTO] AS [FECHA]
   ,[T].[MATERIAL_CODE] AS [MATERIAL_ID]
   ,[T].[MATERIAL_DESCRIPTION] AS [DESCRIPCION]
   ,[T].[QUANTITY_UNITS] AS [CANTIDAD]
   ,[VA].[VALOR_UNITARIO]
   ,([T].[QUANTITY_UNITS] * [VA].[VALOR_UNITARIO]) AS [TOTAL]
   ,CASE [PH].[IS_EXTERNAL_INVENTORY]
      WHEN 1 THEN 'SI'
      ELSE 'NO'
    END AS [IS_EXTERNAL_INVENTORY]
   ,[MH].[TRANSFER_REQUEST_ID]
   ,[MH].[DRIVER]
   ,[MH].[VEHICLE]
   ,[TH].[WAREHOUSE_FROM]
   ,[S].[STATUS_NAME]
   ,CASE [S].[BLOCKS_INVENTORY]
      WHEN 1 THEN 'Si'
      WHEN 0 THEN 'No'
      ELSE 'No'
    END [BLOCKS_INVENTORY]
   ,[S].[COLOR]
   ,[TC].[TONE]
   ,[TC].[CALIBER]
   ,[T].[SERIAL]
   ,[T].[BATCH]
   ,CASE 
      WHEN [T].[BATCH] IS NULL THEN NULL
      WHEN [T].[BATCH] = '' THEN NULL
      ELSE [T].[DATE_EXPIRATION]
    END AS [DATE_EXPIRATION]
   ,[T].[VIN]
  FROM [wms].[OP_WMS_POLIZA_HEADER] AS [PH]
  INNER JOIN [wms].[OP_WMS_TRANS] AS [T]
    ON (
    [PH].[CODIGO_POLIZA] = [T].[CODIGO_POLIZA]
    AND [T].[STATUS] = @STATUS
    )
  INNER JOIN @WAREHOUSES AS [W]
    ON (
    [T].[SOURCE_WAREHOUSE] = [W].[WAREHOUSE_ID] COLLATE database_default
    OR [T].[TARGET_WAREHOUSE] = [W].[WAREHOUSE_ID] COLLATE database_default
    )
  INNER JOIN [wms].[OP_WMS_INV_X_LICENSE] [IXL]
    ON (
    [IXL].[LICENSE_ID] = [T].[LICENSE_ID]
    AND [IXL].[MATERIAL_ID] = [T].[MATERIAL_CODE]
    )
  INNER JOIN [wms].[OP_WMS_STATUS_OF_MATERIAL_BY_LICENSE] [S]
    ON (
    [IXL].[STATUS_ID] = [S].[STATUS_ID]
    )
  LEFT JOIN [wms].[OP_WMS_VIEW_VALORIZACION_ALMGEN] AS [VA]
    ON (
    [VA].[CODIGO_POLIZA] = [T].[CODIGO_POLIZA]
    AND [VA].[LICENSE_ID] = [T].[LICENSE_ID]
    AND [VA].[MATERIAL_ID] = [T].[MATERIAL_CODE]
    )
  LEFT JOIN [wms].[OP_WMS_ERP_RECEPTION_DOCUMENT_HEADER] [RH]
    ON ([RH].[DOC_ID_POLIZA] = [PH].[DOC_ID])
  LEFT JOIN [wms].[OP_WMS_TRANSFER_REQUEST_HEADER] [TH]
    ON ([TH].[TRANSFER_REQUEST_ID] = [T].[TRANSFER_REQUEST_ID])
  LEFT JOIN [wms].[OP_WMS_MANIFEST_HEADER] [MH]
    ON ([MH].[MANIFEST_HEADER_ID] = [RH].[DOC_ID])
  INNER JOIN @CLIENT [CL]
    ON [CL].[CLIENT_CODE] = [T].[CLIENT_OWNER]
  LEFT JOIN [wms].[OP_WMS_TONE_AND_CALIBER_BY_MATERIAL] [TC]
    ON (
    [IXL].[TONE_AND_CALIBER_ID] = [TC].[TONE_AND_CALIBER_ID]
    )
  WHERE [T].[SERIAL_NUMBER] > 0
  AND [PH].[FECHA_DOCUMENTO] BETWEEN @FECHA_INICIO AND @FECHA_FINAL
  AND [PH].[WAREHOUSE_REGIMEN] = @WAREHOUSE_REGIMEN
  AND [PH].[TIPO] = @TIPO
  AND (
  [T].[TRANS_TYPE] = @TRANS_TYPE_INICIALIZACION_GENERAL
  OR [T].[TRANS_TYPE] = @TRANS_TYPE_INGRESO_GENERAL
  );
END;